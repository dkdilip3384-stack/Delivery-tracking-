<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuel Savvy Pro</title>
    
    <!-- PWA & Mobile Web App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="application-name" content="Fuel Savvy Pro">
    
    <!-- Embedded Manifest for "Add to Home Screen" functionality -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRnVlbCBTYXZ2eSBQcm8iLCJzaG9ydF9uYW1lIjoiRnVlbCBTYXZ2eSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGYxNzJhIiwidGhlbWVfY29sb3IiOiIjMGYxNzJhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9naC93YWxrYmxlL2Z1ZWwtc2F2dnktaWNvbi9pY29uLnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19" />

    <!-- Global Process Shim -->
    <script>
        window.process = {
            env: {
                API_KEY: '' 
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 
                            900: '#0f172a', 
                            800: '#1e293b', 
                            700: '#334155', 
                            600: '#475569' 
                        },
                        brand: { 
                            400: '#4ade80', 
                            500: '#22c55e', 
                            600: '#16a34a' 
                        }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: {
                        'in': 'in 0.2s ease-out',
                        'slide-in-from-bottom': 'slideInFromBottom 0.3s ease-out'
                    },
                    keyframes: {
                        slideInFromBottom: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom"
      }
    }
    </script>

    <style>
        /* Custom Map Styles */
        .leaflet-container {
            background-color: #202020; /* Dark grey instead of black to show loading */
            width: 100%;
            height: 100%;
        }
        /* Custom Scrollbar for Dark Mode */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        /* Leaflet Marker Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        @keyframes pulse-dot {
            0% { transform: scale(0.8); }
            50% { transform: scale(1); }
            100% { transform: scale(0.8); }
        }
        .touch-action-none { touch-action: none; }
        
        /* Make Google Maps tiles look slightly darker/cooler if needed, but keeping raw for max clarity */
        .leaflet-tile {
            filter: brightness(0.95) contrast(1.1);
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-dark-900 text-white h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Settings, Play, Square, CheckCircle, Navigation, History, 
            Sparkles, Bike, Cloud, CloudOff, RefreshCw, Trash2, Fuel, 
            AlertTriangle, IndianRupee, ArrowLeft, Calendar, 
            X, Save, MapPin, Crosshair, Maximize, Minimize, Check,
            TrendingUp, Droplets, List, Map as MapIcon, Target, Lock, Unlock, Download,
            Zap, CalendarDays, CalendarRange, Clock, Upload, Database, FileUp, FileDown,
            Edit3, FileText, Share2
        } from 'lucide-react';

        const L = window.L;

        /*******************************************************
         * TYPES & CONSTANTS
         *******************************************************/
        const TripStatus = {
            IDLE: 'IDLE',
            FORWARD: 'FORWARD',
            RETURN: 'RETURN',
            COMPLETED: 'COMPLETED'
        };

        // Default Location: Thalambur
        const THALAMBUR_LOCATION = { lat: 12.8664, lng: 80.2209 };

        const DEFAULT_SETTINGS = {
            tankCapacity: 11,
            currentFuelLevel: 5.0,
            reserveLimit: 2.0,
            mileage: 40,
            fuelPrice: 103,
            lastFuelPriceUpdate: 0,
            forwardRate: 10, // Fixed: 10 Rs
            reverseRate: 5,  // Fixed: 5 Rs
            storeLocation: THALAMBUR_LOCATION
        };

        const STORAGE_KEY_SETTINGS = 'fuel-savvy-settings-v3'; 
        const STORAGE_KEY_LOGS = 'fuel-savvy-logs-v3';
        const STORAGE_KEY_REFUELS = 'fuel-savvy-refuels-v3';
        const STORAGE_KEY_ACTIVE_TRIP = 'fuel-savvy-active-trip-v3';
        const STORAGE_KEY_LAST_LOCATION = 'fuel-savvy-last-location-v3';
        const STORAGE_KEY_STORE_LOC = 'fuel-savvy-store-locked-v1'; // Separated for persistence

        /*******************************************************
         * UTILS (geoUtils)
         *******************************************************/
        const deg2rad = (deg) => deg * (Math.PI / 180);

        const calculateDistance = (coord1, coord2) => {
            if (!coord1 || !coord2) return 0;
            const R = 6371; 
            const dLat = deg2rad(coord2.lat - coord1.lat);
            const dLon = deg2rad(coord2.lng - coord1.lng);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(coord1.lat)) *
                Math.cos(deg2rad(coord2.lat)) *
                Math.sin(dLon / 2) *
                Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0,
            }).format(amount);
        };

        const formatDistance = (km) => {
            if (km < 1) {
                return `${(km * 1000).toFixed(0)} m`;
            }
            return `${km.toFixed(2)} km`;
        };

        const formatDate = (timestamp) => {
            return new Date(timestamp).toLocaleDateString('en-IN', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });
        };

        // Date Helpers for History
        const getStartOfDay = (ts) => {
            const d = new Date(ts);
            d.setHours(0,0,0,0);
            return d.getTime();
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return [d.getUTCFullYear(), weekNo];
        };

        const getMonthKey = (ts) => {
            const d = new Date(ts);
            return `${d.getFullYear()}-${d.getMonth()}`; // e.g. "2023-9" for Oct
        };

        const getMonthName = (yearMonthKey) => {
            const [year, month] = yearMonthKey.split('-');
            const d = new Date(parseInt(year), parseInt(month));
            return d.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
        };
        
        // --- DEEP LINK PARSER ---
        const parseDeepLink = () => {
            const url = window.location.href;
            
            // 1. Handle Geo URIs (geo:lat,lng)
            const geoMatch = decodeURIComponent(url).match(/geo:(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (geoMatch) {
                return { lat: parseFloat(geoMatch[1]), lng: parseFloat(geoMatch[2]) };
            }
            
            // 2. Handle Google Maps Parameters (q=lat,lng)
            const urlObj = new URL(url);
            const params = new URLSearchParams(urlObj.search);
            
            if (params.get('lat') && params.get('lng')) {
                return { lat: parseFloat(params.get('lat')), lng: parseFloat(params.get('lng')) };
            }
            
            const q = params.get('q');
            if (q) {
                // Check if q is lat,lng
                const parts = q.split(',');
                if (parts.length >= 2) {
                    const lat = parseFloat(parts[0]);
                    const lng = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lng)) return { lat, lng };
                }
            }
            
            // 3. Handle @lat,lng format
            const atMatch = urlObj.pathname.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (atMatch) {
                return { lat: parseFloat(atMatch[1]), lng: parseFloat(atMatch[2]) };
            }
            
            return null;
        };

        /*******************************************************
         * SERVICES (dataService)
         *******************************************************/
        const getLocalLogs = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_LOGS);
                return saved ? JSON.parse(saved) : [];
            } catch (e) { return []; }
        };

        const saveLogLocal = (log) => {
            const logs = getLocalLogs();
            const newLog = { ...log, synced: false };
            const updatedLogs = [newLog, ...logs];
            localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(updatedLogs));
            return updatedLogs;
        };

        const mockUploadLog = async (log) => {
            await new Promise(resolve => setTimeout(resolve, 800));
            return true;
        };

        const syncPendingLogs = async () => {
            if (!navigator.onLine) throw new Error("No internet connection");
            const logs = getLocalLogs();
            let hasChanges = false;
            const updatedLogs = await Promise.all(logs.map(async (log) => {
                if (!log.synced) {
                    try {
                        const success = await mockUploadLog(log);
                        if (success) {
                            hasChanges = true;
                            return { ...log, synced: true };
                        }
                    } catch (err) {}
                }
                return log;
            }));
            if (hasChanges) localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(updatedLogs));
            return updatedLogs;
        };

        const clearSyncedLogs = () => {
            const logs = getLocalLogs();
            const pendingLogs = logs.filter(log => !log.synced);
            localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(pendingLogs));
            return pendingLogs;
        };

        const getRefuelLogs = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_REFUELS);
                return saved ? JSON.parse(saved) : [];
            } catch (e) { return []; }
        };

        const saveRefuelLog = (log) => {
            const logs = getRefuelLogs();
            const updatedLogs = [log, ...logs];
            localStorage.setItem(STORAGE_KEY_REFUELS, JSON.stringify(updatedLogs));
            return updatedLogs;
        };

        const saveActiveTripState = (state) => {
            localStorage.setItem(STORAGE_KEY_ACTIVE_TRIP, JSON.stringify(state));
        };

        const getActiveTripState = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_ACTIVE_TRIP);
                return saved ? JSON.parse(saved) : null;
            } catch (e) { return null; }
        };

        const clearActiveTripState = () => {
            localStorage.removeItem(STORAGE_KEY_ACTIVE_TRIP);
        };

        /*******************************************************
         * COMPONENT: MainMap
         *******************************************************/
        const MainMap = ({ currentLocation, settings, targetLocation, tripStatus }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const storeMarkerRef = useRef(null);
            const targetMarkerRef = useRef(null);
            const geofenceCircleRef = useRef(null);
            const routeLineRef = useRef(null);

            useEffect(() => {
                if (mapContainerRef.current && !mapInstanceRef.current) {
                    const initialCenter = currentLocation 
                        ? [currentLocation.lat, currentLocation.lng]
                        : [settings.storeLocation.lat, settings.storeLocation.lng];

                    const map = L.map(mapContainerRef.current, {
                        zoomControl: false,
                        attributionControl: false,
                        maxZoom: 20
                    }).setView(initialCenter, 16);

                    // GOOGLE MAPS HYBRID
                    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    }).addTo(map);

                    mapInstanceRef.current = map;
                }

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                        userMarkerRef.current = null;
                        storeMarkerRef.current = null;
                        geofenceCircleRef.current = null;
                        targetMarkerRef.current = null;
                        routeLineRef.current = null;
                    }
                };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;

                // 1. Store Marker (Green)
                const storeIcon = L.divIcon({
                    className: 'store-icon',
                    html: `<div style="background-color: #22c55e; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #22c55e;"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                if (storeMarkerRef.current) {
                    storeMarkerRef.current.setLatLng([settings.storeLocation.lat, settings.storeLocation.lng]);
                } else {
                    storeMarkerRef.current = L.marker([settings.storeLocation.lat, settings.storeLocation.lng], { icon: storeIcon }).addTo(map);
                }

                // 2. Geofence Circle
                if (geofenceCircleRef.current) {
                    geofenceCircleRef.current.setLatLng([settings.storeLocation.lat, settings.storeLocation.lng]);
                } else {
                    geofenceCircleRef.current = L.circle([settings.storeLocation.lat, settings.storeLocation.lng], {
                        color: '#4ade80',
                        fillColor: '#4ade80',
                        fillOpacity: 0.15,
                        radius: 100, // 100 meters
                        weight: 2,
                        dashArray: '6, 6',
                        interactive: false
                    }).addTo(map);
                }

                // 3. User Marker
                if (currentLocation) {
                    const userIcon = L.divIcon({
                        className: 'user-icon',
                        html: `<div class="relative flex items-center justify-center w-8 h-8">
                                <div class="absolute w-full h-full bg-blue-500/30 rounded-full animate-ping"></div>
                                <div class="absolute w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-[0_0_10px_rgba(59,130,246,0.8)] z-20"></div>
                            </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    if (userMarkerRef.current) {
                        userMarkerRef.current.setLatLng([currentLocation.lat, currentLocation.lng]);
                        userMarkerRef.current.setZIndexOffset(1000);
                    } else {
                        userMarkerRef.current = L.marker([currentLocation.lat, currentLocation.lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
                    }
                    
                    if (!targetLocation) {
                        map.panTo([currentLocation.lat, currentLocation.lng], { animate: true, duration: 0.5 });
                    }
                }

                // 4. Target Marker
                if (targetLocation) {
                    const targetIcon = L.divIcon({
                        className: 'target-icon',
                        html: `<div class="relative flex items-center justify-center w-8 h-8">
                                <div class="absolute w-full h-full bg-red-600/30 rounded-full animate-pulse"></div>
                                <div class="absolute w-4 h-4 bg-red-600 rounded-full border-2 border-white shadow-lg z-20 flex items-center justify-center"></div>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    if (targetMarkerRef.current) {
                        targetMarkerRef.current.setLatLng([targetLocation.lat, targetLocation.lng]);
                    } else {
                        targetMarkerRef.current = L.marker([targetLocation.lat, targetLocation.lng], { icon: targetIcon })
                            .addTo(map)
                            .bindPopup("Destination")
                            .openPopup();
                    }

                    if (currentLocation) {
                        const bounds = L.latLngBounds(
                            [currentLocation.lat, currentLocation.lng],
                            [targetLocation.lat, targetLocation.lng]
                        );
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 18 });
                    }
                } else {
                    if (targetMarkerRef.current) {
                        targetMarkerRef.current.remove();
                        targetMarkerRef.current = null;
                    }
                }

                // 5. Visual Route Lines (Polylines)
                if (routeLineRef.current) {
                    routeLineRef.current.remove();
                    routeLineRef.current = null;
                }

                if (currentLocation) {
                    let lineCoords = [];
                    let lineColor = '#3b82f6'; // Default Blue

                    if (tripStatus === TripStatus.FORWARD) {
                        // Forward: Store -> User
                        lineCoords = [
                            [settings.storeLocation.lat, settings.storeLocation.lng],
                            [currentLocation.lat, currentLocation.lng]
                        ];
                        lineColor = '#3b82f6'; // Blue
                    } else if (tripStatus === TripStatus.RETURN) {
                        // Return: User -> Store
                        lineCoords = [
                            [currentLocation.lat, currentLocation.lng],
                            [settings.storeLocation.lat, settings.storeLocation.lng]
                        ];
                        lineColor = '#f97316'; // Orange
                    } else if (targetLocation) {
                        // Target: User -> Target
                        lineCoords = [
                            [currentLocation.lat, currentLocation.lng],
                            [targetLocation.lat, targetLocation.lng]
                        ];
                        lineColor = '#ef4444'; // Red
                    }

                    if (lineCoords.length > 0) {
                        routeLineRef.current = L.polyline(lineCoords, {
                            color: lineColor,
                            weight: 3,
                            opacity: 0.8,
                            dashArray: '10, 10', // Dashed line to indicate direct path
                            lineCap: 'round'
                        }).addTo(map);
                    }
                }

            }, [currentLocation, settings.storeLocation, targetLocation, tripStatus]);

            return <div ref={mapContainerRef} className="h-full w-full bg-dark-900 touch-none" />;
        };

        /*******************************************************
         * COMPONENT: SettingsDialog
         *******************************************************/
        const SettingsDialog = ({ isOpen, onClose, settings, onSave }) => {
            const [formData, setFormData] = useState(settings);
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const [isLocating, setIsLocating] = useState(false);
            const [isEditingMap, setIsEditingMap] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    setFormData(settings);
                    setIsEditingMap(false);
                }
            }, [isOpen, settings]);

            useEffect(() => {
                if (isOpen && mapContainerRef.current) {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }

                    // Only allow interaction if editing
                    const map = L.map(mapContainerRef.current, {
                        zoomControl: false,
                        maxZoom: 20,
                        dragging: isEditingMap,
                        touchZoom: isEditingMap,
                        doubleClickZoom: isEditingMap,
                        scrollWheelZoom: isEditingMap,
                        zoomSnap: 0.1
                    }).setView([formData.storeLocation.lat, formData.storeLocation.lng], 17);

                    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    }).addTo(map);

                    const storeIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="position: relative; width: 30px; height: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                                <svg width="30" height="30" viewBox="0 0 24 24" fill="#22c55e" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                            </div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    });

                    const marker = L.marker([formData.storeLocation.lat, formData.storeLocation.lng], { 
                        icon: storeIcon,
                        draggable: isEditingMap
                    }).addTo(map);

                    marker.on('dragend', (event) => {
                        const position = event.target.getLatLng();
                        setFormData(prev => ({ ...prev, storeLocation: { lat: position.lat, lng: position.lng } }));
                    });

                    map.on('click', (e) => {
                        if(isEditingMap) {
                            marker.setLatLng(e.latlng);
                            setFormData(prev => ({ ...prev, storeLocation: { lat: e.latlng.lat, lng: e.latlng.lng } }));
                        }
                    });

                    mapInstanceRef.current = map;
                    markerRef.current = marker;

                    setTimeout(() => map.invalidateSize(), 200);
                } 
            }, [isOpen, isEditingMap]); // Re-init map when mode changes to apply draggable settings clearly

            const toggleEditMode = () => {
                setIsEditingMap(!isEditingMap);
                setTimeout(() => {
                        if(mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                }, 100);
            };

            const handleLocateMe = () => {
                if(!isEditingMap) return;
                setIsLocating(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        const newLatLng = new L.LatLng(latitude, longitude);
                        mapInstanceRef.current?.setView(newLatLng, 18);
                        markerRef.current?.setLatLng(newLatLng);
                        setFormData(prev => ({ ...prev, storeLocation: { lat: latitude, lng: longitude } }));
                        setIsLocating(false);
                    },
                    () => {
                        alert("Could not get location.");
                        setIsLocating(false);
                    },
                    { enableHighAccuracy: true }
                );
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: parseFloat(value) }));
            };

            const handleDownloadApk = () => {
                const repoUrl = 'https://github.com/dkdilip3384-stack/Delivery-tracking-/actions';
                
                if(window.confirm("Open GitHub Actions page to download the latest APK?")) {
                     window.open(repoUrl, '_system');
                }
            };

            // --- PDF REPORT GENERATION ---
            const handleDownloadPDF = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) { alert("PDF Library not loaded. Check internet."); return; }
                    
                    const doc = new jsPDF();
                    const logs = JSON.parse(localStorage.getItem(STORAGE_KEY_LOGS) || '[]');
                    const refuels = JSON.parse(localStorage.getItem(STORAGE_KEY_REFUELS) || '[]');

                    // --- HEADER ---
                    doc.setFillColor(34, 197, 94); // Brand Green
                    doc.rect(0, 0, 210, 20, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.text("Fuel Savvy Pro - Activity Report", 14, 13);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);
                    
                    // --- SUMMARY ---
                    let totalEarnings = logs.reduce((acc, l) => acc + l.totalRevenue, 0);
                    let totalDistance = logs.reduce((acc, l) => acc + (l.forwardDistance + l.reverseDistance), 0);
                    let totalFuelCost = refuels.reduce((acc, r) => acc + r.cost, 0);

                    doc.setFontSize(12);
                    doc.setTextColor(50);
                    doc.text("Summary Overview:", 14, 40);
                    
                    doc.setFontSize(10);
                    doc.text(`Total Earnings: ${formatCurrency(totalEarnings)}`, 14, 48);
                    doc.text(`Total Distance: ${totalDistance.toFixed(2)} km`, 80, 48);
                    doc.text(`Fuel Expense: ${formatCurrency(totalFuelCost)}`, 150, 48);
                    
                    // --- TRIPS TABLE ---
                    doc.setFontSize(12);
                    doc.setTextColor(34, 197, 94);
                    doc.text("Trip History", 14, 60);
                    
                    const tripRows = logs.map(l => [
                        new Date(l.startTime).toLocaleDateString(),
                        new Date(l.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                        (l.forwardDistance + l.reverseDistance).toFixed(2) + ' km',
                        formatCurrency(l.totalRevenue)
                    ]);

                    doc.autoTable({
                        head: [['Date', 'Time', 'Distance', 'Earnings']],
                        body: tripRows,
                        startY: 65,
                        theme: 'grid',
                        headStyles: { fillColor: [34, 197, 94] }
                    });

                    // --- REFUEL TABLE ---
                    let finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(12);
                    doc.setTextColor(239, 68, 68); // Red
                    doc.text("Refuel History", 14, finalY);
                    
                    const refuelRows = refuels.map(r => [
                        new Date(r.date).toLocaleDateString(),
                        r.liters.toFixed(2) + ' L',
                        formatCurrency(r.cost)
                    ]);

                    doc.autoTable({
                        head: [['Date', 'Liters', 'Cost']],
                        body: refuelRows,
                        startY: finalY + 5,
                        theme: 'grid',
                        headStyles: { fillColor: [239, 68, 68] }
                    });

                    doc.save(`FuelSavvy_Report_${new Date().toISOString().slice(0,10)}.pdf`);
                } catch (e) {
                    console.error(e);
                    alert("Error creating PDF: " + e.message);
                }
            };

            // --- JSON BACKUP LOGIC ---
            const handleExportData = () => {
                try {
                    const backup = {
                        version: 1,
                        timestamp: Date.now(),
                        settings: JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS) || '{}'),
                        logs: JSON.parse(localStorage.getItem(STORAGE_KEY_LOGS) || '[]'),
                        refuels: JSON.parse(localStorage.getItem(STORAGE_KEY_REFUELS) || '[]'),
                        activeTrip: JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIVE_TRIP) || 'null'),
                        storeLoc: JSON.parse(localStorage.getItem(STORAGE_KEY_STORE_LOC) || 'null'),
                    };
                    
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const dateStr = new Date().toISOString().slice(0,10);
                    a.href = url;
                    a.download = `FuelSavvy_Backup_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert("System Backup Saved! Keep this file safe for restoring later.");
                } catch(e) {
                    alert("Export failed: " + e.message);
                }
            };

            const handleImportClick = () => {
                fileInputRef.current?.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!window.confirm("Restoring will OVERWRITE current data. Are you sure?")) {
                    e.target.value = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.settings && data.logs) {
                            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(data.settings));
                            localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(data.logs));
                            localStorage.setItem(STORAGE_KEY_REFUELS, JSON.stringify(data.refuels || []));
                            if(data.activeTrip) localStorage.setItem(STORAGE_KEY_ACTIVE_TRIP, JSON.stringify(data.activeTrip));
                            if(data.storeLoc) localStorage.setItem(STORAGE_KEY_STORE_LOC, JSON.stringify(data.storeLoc));
                            
                            alert("Restore Successful! App will restart.");
                            window.location.reload();
                        } else {
                            throw new Error("Invalid backup file format");
                        }
                    } catch(err) {
                        alert("Failed to restore: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm font-sans">
                    <div className="bg-dark-800 w-full max-w-lg rounded-2xl shadow-2xl border border-dark-700 overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="flex justify-between items-center p-4 border-b border-dark-700 bg-dark-900/50">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Settings size={20} className="text-brand-500" /> Settings
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors text-gray-400 hover:text-white">
                                <X size={20} />
                            </button>
                        </div>
                        
                        {/* MAP CONTAINER - Transitions between small and fixed-fullscreen */}
                        <div className={`relative bg-gray-900 transition-all duration-300 ease-in-out ${isEditingMap ? 'fixed inset-0 z-[60] h-screen w-screen border-0' : 'h-36 w-full shrink-0 border-b border-dark-700'}`}>
                            
                            <div ref={mapContainerRef} className={`h-full w-full z-0 touch-none ${!isEditingMap ? 'pointer-events-none opacity-80 grayscale-[0.3]' : 'opacity-100'}`} />
                            
                            {/* LOCKED PREVIEW STATE OVERLAY */}
                            {!isEditingMap && (
                                <div className="absolute inset-0 z-[10] flex items-center justify-center bg-black/20 hover:bg-black/10 transition-colors cursor-pointer group" onClick={toggleEditMode}>
                                    <button className="bg-dark-800/90 hover:bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 shadow-lg backdrop-blur-sm transition-all transform group-active:scale-95 border border-white/10">
                                        <Edit3 size={14} /> Change Location
                                    </button>
                                </div>
                            )}

                            {/* COORDINATES DISPLAY */}
                            <div className="absolute top-2 right-2 bg-black/60 text-white backdrop-blur px-2 py-1 rounded text-xs font-mono font-bold z-[400] border border-white/10 pointer-events-none shadow-sm">
                                {formData.storeLocation.lat.toFixed(5)}, {formData.storeLocation.lng.toFixed(5)}
                            </div>
                            
                            {/* EDIT MODE CONTROLS */}
                            {isEditingMap && (
                                <>
                                    <div className="absolute top-4 left-4 z-[400]">
                                        <button onClick={toggleEditMode} className="bg-white text-dark-900 px-4 py-2 rounded-lg shadow-lg font-bold text-xs flex items-center gap-2 active:scale-95 transition-transform">
                                            <X size={16}/> Cancel
                                        </button>
                                    </div>

                                    <button onClick={handleLocateMe} className="absolute bottom-24 right-4 bg-white text-dark-900 p-3 rounded-full shadow-lg z-[400] hover:bg-gray-100 active:scale-95 transition-all border border-gray-200">
                                        <Crosshair size={24} className={isLocating ? 'animate-spin text-brand-500' : 'text-dark-800'} />
                                    </button>

                                    <div className="absolute bottom-8 left-0 right-0 flex justify-center z-[400] pointer-events-none">
                                        <button onClick={toggleEditMode} className="pointer-events-auto bg-brand-600 text-white font-bold py-3 px-8 rounded-full shadow-xl hover:bg-brand-500 transition-all flex items-center gap-2 transform active:scale-95 border-2 border-white/20 text-lg">
                                            <Check size={24} /> Set Location
                                        </button>
                                    </div>
                                    
                                    <div className="absolute top-16 inset-x-0 flex justify-center pointer-events-none z-[400]">
                                        <div className="bg-black/60 backdrop-blur px-4 py-2 rounded-full text-white text-xs font-bold border border-white/10 shadow-lg">
                                            Drag map to pin store location
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-dark-900">
                            
                            <div className="bg-dark-800 rounded-xl p-4 border border-dark-700">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2"><Fuel size={14}/> Fuel & Vehicle</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-xs text-brand-400 font-bold mb-1">Current Fuel Level (L)</label>
                                    <div className="relative">
                                        <input type="number" name="currentFuelLevel" value={isNaN(formData.currentFuelLevel) ? '' : formData.currentFuelLevel} onChange={handleChange} step="0.1" className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2.5 pl-3 text-white font-bold focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none" />
                                        <span className="absolute right-3 top-2.5 text-gray-500 text-sm">Liters</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Tank Size</label>
                                        <div className="relative">
                                            <input type="number" name="tankCapacity" value={formData.tankCapacity} onChange={handleChange} className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2 text-sm text-white focus:border-brand-500 outline-none" />
                                            <span className="absolute right-2 top-2 text-gray-600 text-xs">L</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Mileage</label>
                                        <div className="relative">
                                            <input type="number" name="mileage" value={formData.mileage} onChange={handleChange} className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2 text-sm text-white focus:border-brand-500 outline-none" />
                                            <span className="absolute right-2 top-2 text-gray-600 text-xs">km/L</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-dark-800 rounded-xl p-4 border border-dark-700">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2"><IndianRupee size={14}/> Rates & Prices</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Petrol Price</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2.5 text-gray-500 text-sm">₹</span>
                                        <input type="number" name="fuelPrice" value={formData.fuelPrice} onChange={handleChange} className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2.5 pl-7 text-white font-medium focus:border-brand-500 outline-none" />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Forward Rate</label>
                                        <div className="relative">
                                            <span className="absolute left-2 top-2 text-gray-600 text-xs">₹</span>
                                            <input type="number" name="forwardRate" value={formData.forwardRate} onChange={handleChange} className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2 pl-5 text-sm text-white focus:border-brand-500 outline-none" />
                                            <span className="absolute right-2 top-2 text-gray-600 text-[10px]">/km</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Reverse Rate</label>
                                        <div className="relative">
                                            <span className="absolute left-2 top-2 text-gray-600 text-xs">₹</span>
                                            <input type="number" name="reverseRate" value={formData.reverseRate} onChange={handleChange} className="w-full bg-dark-900 border border-dark-600 rounded-lg p-2 pl-5 text-sm text-white focus:border-brand-500 outline-none" />
                                            <span className="absolute right-2 top-2 text-gray-600 text-[10px]">/km</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* DATA BACKUP & PDF SECTION */}
                            <div className="bg-gradient-to-br from-blue-900/20 to-indigo-900/20 rounded-xl p-4 border border-blue-500/30">
                                <h3 className="text-xs font-bold text-blue-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <Database size={14}/> Data & Reports
                                </h3>
                                <div className="space-y-3">
                                    {/* PDF Report */}
                                    <div className="bg-dark-900/50 p-2.5 rounded-lg border border-white/5 flex items-center justify-between">
                                        <div>
                                            <div className="text-xs font-bold text-gray-200">Trip Report (PDF)</div>
                                            <div className="text-[10px] text-gray-500">Readable Report for sharing</div>
                                        </div>
                                        <button onClick={handleDownloadPDF} className="bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg shadow active:scale-95 transition-all flex items-center gap-1.5 text-xs font-bold">
                                            <FileText size={14}/> Download PDF
                                        </button>
                                    </div>

                                    {/* JSON Backup */}
                                    <div className="bg-dark-900/50 p-2.5 rounded-lg border border-white/5 flex items-center justify-between">
                                        <div>
                                            <div className="text-xs font-bold text-gray-200">System Backup</div>
                                            <div className="text-[10px] text-gray-500">Save data file to restore later</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={handleImportClick} className="bg-dark-700 hover:bg-dark-600 text-gray-300 p-2 rounded-lg border border-white/10 active:scale-95 transition-all text-xs font-bold">
                                                Restore
                                            </button>
                                            <button onClick={handleExportData} className="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg shadow active:scale-95 transition-all flex items-center gap-1.5 text-xs font-bold">
                                                <Database size={14}/> Backup
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        className="hidden" 
                                        accept=".json" 
                                        onChange={handleFileChange}
                                    />
                                </div>
                                <div className="mt-3 text-[10px] text-gray-500 text-center flex items-center justify-center gap-1">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                    Offline-First: Data saved locally & auto-syncs on connection.
                                </div>
                            </div>

                             <div className="bg-dark-800 rounded-xl p-4 border border-dark-700">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2"><Download size={14}/> Install App</h3>
                                <button onClick={handleDownloadApk} className="w-full bg-dark-700 hover:bg-dark-600 text-brand-400 font-bold py-3 rounded-lg flex items-center justify-center gap-2 border border-brand-500/20 transition-all">
                                    <Download size={16} /> Download Latest APK
                                </button>
                            </div>

                        </div>
                        
                        <div className="p-4 border-t border-dark-700 bg-dark-900">
                            <button onClick={() => { onSave(formData); onClose(); }} className="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3.5 px-6 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-brand-500/20 active:scale-95">
                                <Save size={20} /> Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        /*******************************************************
         * COMPONENT: HistoryPage (UNIQUE & REDESIGNED)
         *******************************************************/
        const HistoryPage = ({ logs, refuelLogs, onBack, onClearSynced }) => {
            const [activeTab, setActiveTab] = useState('TRIPS'); // TRIPS | REFUEL
            const [historyView, setHistoryView] = useState('DAILY'); // DAILY | WEEKLY | MONTHLY

            // --- DATA PROCESSING LOGIC ---
            
            // 1. Daily Grouping
            const getDailyGroups = (data, dateKey = 'startTime') => {
                const groups = {};
                data.forEach(item => {
                    const date = new Date(item[dateKey]);
                    const key = date.toLocaleDateString('en-IN'); // e.g., "10/10/2023"
                    const sortKey = getStartOfDay(item[dateKey]);
                    if (!groups[key]) groups[key] = { key, sortKey, items: [], total: 0, dist: 0 };
                    groups[key].items.push(item);
                    if (dateKey === 'startTime') { // TRIPS
                         groups[key].total += item.totalRevenue;
                         groups[key].dist += (item.forwardDistance + item.reverseDistance);
                    } else { // REFUEL
                        groups[key].total += item.cost;
                        groups[key].dist += item.liters; // Storing Liters in dist for refuel
                    }
                });
                return Object.values(groups).sort((a, b) => b.sortKey - a.sortKey);
            };

            // 2. Weekly Grouping
            const getWeeklyGroups = (data, dateKey = 'startTime') => {
                const groups = {};
                data.forEach(item => {
                    const d = new Date(item[dateKey]);
                    const [year, week] = getWeekNumber(d);
                    const key = `${year}-W${week}`;
                    if (!groups[key]) groups[key] = { key, year, week, total: 0, dist: 0, items: [] };
                    groups[key].items.push(item);
                    if (dateKey === 'startTime') {
                        groups[key].total += item.totalRevenue;
                        groups[key].dist += (item.forwardDistance + item.reverseDistance);
                    } else {
                        groups[key].total += item.cost;
                        groups[key].dist += item.liters;
                    }
                });
                return Object.values(groups).sort((a, b) => (b.year * 100 + b.week) - (a.year * 100 + a.week));
            };

            // 3. Monthly Grouping
            const getMonthlyGroups = (data, dateKey = 'startTime') => {
                const groups = {};
                data.forEach(item => {
                    const key = getMonthKey(item[dateKey]);
                    if (!groups[key]) groups[key] = { key, total: 0, dist: 0, items: [] };
                    groups[key].items.push(item);
                    if (dateKey === 'startTime') {
                        groups[key].total += item.totalRevenue;
                        groups[key].dist += (item.forwardDistance + item.reverseDistance);
                    } else {
                        groups[key].total += item.cost;
                        groups[key].dist += item.liters;
                    }
                });
                return Object.values(groups).sort((a, b) => {
                    const [y1, m1] = a.key.split('-');
                    const [y2, m2] = b.key.split('-');
                    return new Date(y2, m2) - new Date(y1, m1);
                });
            };

            const dailyData = useMemo(() => getDailyGroups(activeTab === 'TRIPS' ? logs : refuelLogs, activeTab === 'TRIPS' ? 'startTime' : 'date'), [logs, refuelLogs, activeTab]);
            const weeklyData = useMemo(() => getWeeklyGroups(activeTab === 'TRIPS' ? logs : refuelLogs, activeTab === 'TRIPS' ? 'startTime' : 'date'), [logs, refuelLogs, activeTab]);
            const monthlyData = useMemo(() => getMonthlyGroups(activeTab === 'TRIPS' ? logs : refuelLogs, activeTab === 'TRIPS' ? 'startTime' : 'date'), [logs, refuelLogs, activeTab]);

            const renderDailyView = () => (
                <div className="space-y-6">
                    {dailyData.length === 0 && <div className="text-center text-gray-500 py-10 opacity-50">No Data Available</div>}
                    {dailyData.map(group => (
                        <div key={group.key} className="animate-in slide-in-from-bottom">
                            {/* Sticky Date Header */}
                            <div className="sticky top-0 z-10 bg-dark-900/95 backdrop-blur py-2 mb-2 border-b border-dark-700 flex justify-between items-end">
                                <div>
                                    <div className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Date</div>
                                    <div className="text-sm font-bold text-gray-200">{group.key}</div>
                                </div>
                                <div className="text-right">
                                    <div className={`text-lg font-black ${activeTab === 'TRIPS' ? 'text-brand-400' : 'text-red-400'}`}>
                                        {activeTab === 'TRIPS' ? formatCurrency(group.total) : `-${formatCurrency(group.total)}`}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Items List */}
                            <div className="space-y-2">
                                {group.items.sort((a,b) => (b.startTime||b.date) - (a.startTime||a.date)).map(log => (
                                    <div key={log.id} className="bg-dark-800 rounded-lg p-3 border border-dark-700 flex justify-between items-center hover:bg-dark-700/50 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-full ${activeTab === 'TRIPS' ? 'bg-brand-500/10 text-brand-500' : 'bg-red-500/10 text-red-500'}`}>
                                                {activeTab === 'TRIPS' ? <Bike size={16}/> : <Fuel size={16}/>}
                                            </div>
                                            <div>
                                                <div className="text-xs text-gray-400">
                                                    {new Date(log.startTime || log.date).toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'})}
                                                </div>
                                                <div className="text-sm font-bold text-white">
                                                    {activeTab === 'TRIPS' ? formatDistance(log.forwardDistance + log.reverseDistance) : `${log.liters.toFixed(2)} L`}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`font-bold ${activeTab === 'TRIPS' ? 'text-white' : 'text-gray-300'}`}>
                                                {activeTab === 'TRIPS' ? formatCurrency(log.totalRevenue) : formatCurrency(log.cost)}
                                            </div>
                                            {activeTab === 'TRIPS' && (
                                                <div className="flex justify-end gap-1 mt-1">
                                                     {log.synced ? <Cloud size={10} className="text-brand-500"/> : <CloudOff size={10} className="text-yellow-500"/>}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );

            const renderAggregatedCard = (title, subTitle, total, metric, isRefuel) => (
                <div className="bg-gradient-to-br from-dark-800 to-dark-700 rounded-xl p-5 border border-white/5 shadow-lg relative overflow-hidden group hover:scale-[1.02] transition-transform">
                    <div className={`absolute top-0 right-0 p-10 bg-gradient-to-br ${isRefuel ? 'from-red-500/10 to-transparent' : 'from-brand-500/10 to-transparent'} rounded-full blur-2xl -mr-10 -mt-10`}></div>
                    <div className="relative z-10 flex justify-between items-start">
                        <div>
                            <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">{subTitle}</div>
                            <div className="text-lg font-bold text-white mb-4">{title}</div>
                            <div className="flex items-center gap-2 text-xs text-gray-500 bg-black/20 w-fit px-2 py-1 rounded-lg">
                                {isRefuel ? <Droplets size={12}/> : <Navigation size={12}/>}
                                {metric}
                            </div>
                        </div>
                        <div className="text-right">
                            <div className={`text-2xl font-black ${isRefuel ? 'text-red-400' : 'text-brand-400'}`}>
                                {isRefuel ? '-' : ''}{formatCurrency(total)}
                            </div>
                            <div className="text-[10px] text-gray-500 font-bold mt-1 uppercase">{isRefuel ? 'Expense' : 'Earnings'}</div>
                        </div>
                    </div>
                </div>
            );

            const renderWeeklyView = () => (
                <div className="space-y-3 pt-2">
                    {weeklyData.length === 0 && <div className="text-center text-gray-500 py-10 opacity-50">No Data Available</div>}
                    {weeklyData.map(group => (
                        <div key={group.key} className="animate-in slide-in-from-bottom">
                            {renderAggregatedCard(
                                `Week ${group.week}, ${group.year}`,
                                "Weekly Summary",
                                group.total,
                                activeTab === 'TRIPS' ? `${formatDistance(group.dist)} Total` : `${group.dist.toFixed(2)}L Fuel`,
                                activeTab === 'REFUEL'
                            )}
                        </div>
                    ))}
                </div>
            );

            const renderMonthlyView = () => (
                <div className="space-y-3 pt-2">
                    {monthlyData.length === 0 && <div className="text-center text-gray-500 py-10 opacity-50">No Data Available</div>}
                    {monthlyData.map(group => (
                        <div key={group.key} className="animate-in slide-in-from-bottom">
                            {renderAggregatedCard(
                                getMonthName(group.key),
                                "Monthly Overview",
                                group.total,
                                activeTab === 'TRIPS' ? `${formatDistance(group.dist)} Total` : `${group.dist.toFixed(2)}L Fuel`,
                                activeTab === 'REFUEL'
                            )}
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="fixed inset-0 z-50 bg-dark-900 flex flex-col animate-in slide-in-from-bottom font-sans">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 border-b border-dark-700 bg-dark-800 shadow-md z-20">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                                <ArrowLeft size={20} className="text-gray-300" />
                            </button>
                            <h2 className="text-xl font-bold text-white">History</h2>
                        </div>
                        <button 
                            onClick={onClearSynced} 
                            className="p-2 text-red-400 hover:bg-red-500/10 rounded-full transition-colors"
                            title="Clear Synced Logs"
                        >
                            <Trash2 size={20} />
                        </button>
                    </div>

                    {/* Main Type Tabs */}
                    <div className="flex p-2 gap-2 bg-dark-900 border-b border-dark-800 z-10">
                        <button 
                            onClick={() => setActiveTab('TRIPS')}
                            className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${activeTab === 'TRIPS' ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/20 scale-[1.02]' : 'bg-dark-800 text-gray-400 hover:bg-dark-700'}`}
                        >
                            <Bike size={16}/> Trips
                        </button>
                        <button 
                            onClick={() => setActiveTab('REFUEL')}
                            className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${activeTab === 'REFUEL' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20 scale-[1.02]' : 'bg-dark-800 text-gray-400 hover:bg-dark-700'}`}
                        >
                            <Fuel size={16}/> Refuels
                        </button>
                    </div>

                    {/* View Filters (Daily/Weekly/Monthly) */}
                    <div className="flex justify-center p-2 bg-dark-900">
                        <div className="flex bg-dark-800 p-1 rounded-lg border border-dark-700 w-full max-w-sm">
                            <button 
                                onClick={() => setHistoryView('DAILY')}
                                className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${historyView === 'DAILY' ? 'bg-dark-600 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}
                            >Daily</button>
                            <button 
                                onClick={() => setHistoryView('WEEKLY')}
                                className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${historyView === 'WEEKLY' ? 'bg-dark-600 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}
                            >Weekly</button>
                            <button 
                                onClick={() => setHistoryView('MONTHLY')}
                                className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${historyView === 'MONTHLY' ? 'bg-dark-600 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}
                            >Monthly</button>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto p-4 bg-dark-900 relative">
                        {historyView === 'DAILY' && renderDailyView()}
                        {historyView === 'WEEKLY' && renderWeeklyView()}
                        {historyView === 'MONTHLY' && renderMonthlyView()}
                    </div>
                </div>
            );
        };

        /*******************************************************
         * COMPONENT: App
         *******************************************************/
        const App = () => {
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [logs, setLogs] = useState([]);
            const [refuelLogs, setRefuelLogs] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isFuelModalOpen, setIsFuelModalOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [tripStatus, setTripStatus] = useState(TripStatus.IDLE);
            
            const [currentLocation, setCurrentLocation] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_LAST_LOCATION);
                    return saved ? JSON.parse(saved) : null;
                } catch(e) { return null; }
            });

            const [startLocation, setStartLocation] = useState(null);
            const [targetLocation, setTargetLocation] = useState(null);
            const [forwardDist, setForwardDist] = useState(0);
            const [reverseDist, setReverseDist] = useState(0);
            const [startTime, setStartTime] = useState(0);
            const [hasLeftGeofence, setHasLeftGeofence] = useState(false);
            const [fuelInputAmount, setFuelInputAmount] = useState('');
            const [fuelInputMode, setFuelInputMode] = useState('AMOUNT');
            const prevLocationRef = useRef(null);
            const stateRef = useRef({ tripStatus, hasLeftGeofence, settings, forwardDist, reverseDist, startLocation, startTime, logs });

            useEffect(() => {
                stateRef.current = { tripStatus, hasLeftGeofence, settings, forwardDist, reverseDist, startLocation, startTime, logs };
            }, [tripStatus, hasLeftGeofence, settings, forwardDist, reverseDist, startLocation, startTime, logs]);

            // LOAD SETTINGS & FIX STORE LOCATION PERSISTENCE
            useEffect(() => {
                // 1. Try to load general settings
                const savedSettingsStr = localStorage.getItem(STORAGE_KEY_SETTINGS);
                let loadedSettings = savedSettingsStr ? JSON.parse(savedSettingsStr) : DEFAULT_SETTINGS;

                // 2. FORCE Override Store Location if Locked Location Exists
                const lockedStoreLoc = localStorage.getItem(STORAGE_KEY_STORE_LOC);
                if (lockedStoreLoc) {
                    const parsedLoc = JSON.parse(lockedStoreLoc);
                    loadedSettings = { ...loadedSettings, storeLocation: parsedLoc };
                }

                setSettings(loadedSettings);
                setLogs(getLocalLogs());
                setRefuelLogs(getRefuelLogs());

                const activeTrip = getActiveTripState();
                if (activeTrip && activeTrip.status !== TripStatus.IDLE) {
                    setTripStatus(activeTrip.status);
                    setStartTime(activeTrip.startTime);
                    setStartLocation(activeTrip.startLocation);
                    setForwardDist(activeTrip.forwardDist);
                    setReverseDist(activeTrip.reverseDist);
                    setHasLeftGeofence(activeTrip.hasLeftGeofence);
                    if (activeTrip.lastKnownLocation) prevLocationRef.current = activeTrip.lastKnownLocation;
                }

                const handleOnlineStatus = () => {
                    setIsOnline(navigator.onLine);
                    if (navigator.onLine) attemptSync();
                };
                window.addEventListener('online', handleOnlineStatus);
                window.addEventListener('offline', handleOnlineStatus);
                if (navigator.onLine) attemptSync();

                // DEEP LINK PARSING - Initial Load
                const target = parseDeepLink();
                if (target) {
                    setTargetLocation(target);
                    if('vibrate' in navigator) navigator.vibrate(50);
                }

                // Handle Cordova/Android warm start via global callback
                window.handleOpenURL = function(url) {
                    // Update the URL manually so our parser reads it
                    window.history.pushState({}, "", url);
                    const newTarget = parseDeepLink();
                    if (newTarget) {
                        setTargetLocation(newTarget);
                        if('vibrate' in navigator) navigator.vibrate(50);
                    }
                };

                return () => {
                    window.removeEventListener('online', handleOnlineStatus);
                    window.removeEventListener('offline', handleOnlineStatus);
                    delete window.handleOpenURL;
                };
            }, []);

            useEffect(() => {
                if (tripStatus !== TripStatus.IDLE) {
                    saveActiveTripState({
                        status: tripStatus,
                        startTime,
                        startLocation,
                        forwardDist,
                        reverseDist,
                        hasLeftGeofence,
                        lastKnownLocation: currentLocation
                    });
                }
            }, [tripStatus, startTime, startLocation, forwardDist, reverseDist, hasLeftGeofence, currentLocation]);

            const attemptSync = async () => {
                setIsSyncing(true);
                try {
                    const updatedLogs = await syncPendingLogs();
                    setLogs(updatedLogs);
                } catch (error) { console.error(error); } 
                finally { setIsSyncing(false); }
            };

            const handleSaveSettings = (newSettings) => {
                setSettings(newSettings);
                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(newSettings));
                // Explicitly save the store location separately to ensure it never gets lost
                localStorage.setItem(STORAGE_KEY_STORE_LOC, JSON.stringify(newSettings.storeLocation));
            };

            const handleAddFuel = () => {
                if (!fuelInputAmount) return;
                const val = parseFloat(fuelInputAmount);
                if (isNaN(val) || val <= 0) return;
                let litersToAdd = fuelInputMode === 'AMOUNT' ? val / settings.fuelPrice : val;
                const spaceInTank = settings.tankCapacity - settings.currentFuelLevel;
                const actualLitersAdded = Math.min(litersToAdd, spaceInTank);
                if (litersToAdd > spaceInTank + 0.01) {
                    if (!window.confirm(`Tank capacity exceeded. Filling only ${actualLitersAdded.toFixed(2)}L. Continue?`)) return;
                }
                const cost = actualLitersAdded * settings.fuelPrice;
                const newRefuel = { id: Date.now().toString(), date: Date.now(), cost, liters: actualLitersAdded, pricePerLiter: settings.fuelPrice };
                const updatedRefuels = saveRefuelLog(newRefuel);
                setRefuelLogs(updatedRefuels);
                const newSettings = { ...settings, currentFuelLevel: Math.min(settings.currentFuelLevel + actualLitersAdded, settings.tankCapacity) };
                handleSaveSettings(newSettings);
                setFuelInputAmount('');
                setIsFuelModalOpen(false);
                alert(`Added ${actualLitersAdded.toFixed(2)}L.`);
            };

            const performFinishTrip = (endLoc) => {
                const state = stateRef.current;
                if (state.tripStatus === TripStatus.IDLE) return;
                const finalEndLocation = endLoc || state.settings.storeLocation; 
                const totalDist = state.forwardDist + state.reverseDist;
                
                // Only save log if distance > 100m
                if (totalDist > 0.1) {
                    const revenue = (state.forwardDist * state.settings.forwardRate) + (state.reverseDist * state.settings.reverseRate);
                    const mileage = state.settings.mileage || 40;
                    const fuelConsumed = totalDist / mileage;
                    const costOfFuelConsumed = fuelConsumed * state.settings.fuelPrice;
                    const newFuelLevel = Math.max(0, state.settings.currentFuelLevel - fuelConsumed);
                    const newSettings = { ...state.settings, currentFuelLevel: newFuelLevel };
                    handleSaveSettings(newSettings);
                    const newLog = {
                        id: Date.now().toString(),
                        date: Date.now(),
                        startTime: state.startTime,
                        endTime: Date.now(),
                        forwardDistance: state.forwardDist,
                        reverseDistance: state.reverseDist,
                        totalRevenue: revenue,
                        fuelCost: costOfFuelConsumed,
                        startLocation: state.startLocation,
                        endLocation: finalEndLocation
                    };
                    const updatedLogs = saveLogLocal(newLog);
                    setLogs(updatedLogs);
                    if (navigator.onLine) attemptSync();
                    if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
                    
                    // Simple Toast
                    const msg = document.createElement('div');
                    msg.innerHTML = `Trip Finished! <br><b>₹${revenue.toFixed(0)}</b> Earned`;
                    msg.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#22c55e; color:white; padding:15px 20px; border-radius:12px; font-weight:bold; box-shadow:0 10px 20px rgba(0,0,0,0.3); z-index:9999; text-align:center;";
                    document.body.appendChild(msg);
                    setTimeout(() => msg.remove(), 4000);
                }

                setTripStatus(TripStatus.IDLE);
                setHasLeftGeofence(false);
                setForwardDist(0);
                setReverseDist(0);
                clearActiveTripState();
                setTargetLocation(null); 
            };

            // Programmatic Start Trip (Called by Geo Watcher)
            const autoStartTrip = (loc) => {
                const state = stateRef.current;
                setStartLocation(loc);
                setStartTime(Date.now());
                setTripStatus(TripStatus.FORWARD);
                setForwardDist(0);
                setReverseDist(0);
                setHasLeftGeofence(true); // Since we auto-started outside, we are already 'out'
                prevLocationRef.current = loc;
                
                if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
            };

            const manualStartTrip = () => {
                 if (!currentLocation) { alert("Waiting for GPS..."); return; }
                 setStartLocation(currentLocation);
                 setStartTime(Date.now());
                 setTripStatus(TripStatus.FORWARD);
                 setForwardDist(0);
                 setReverseDist(0);
                 setHasLeftGeofence(false); // Manually starting likely means at store
                 prevLocationRef.current = currentLocation;
            };

            // Updated Geolocation Handling - THE BRAIN
            useEffect(() => {
                if (!navigator.geolocation) return;

                const watcher = navigator.geolocation.watchPosition(
                    (pos) => {
                        const newCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        setCurrentLocation(newCoords);
                        localStorage.setItem(STORAGE_KEY_LAST_LOCATION, JSON.stringify(newCoords)); 
                        
                        const state = stateRef.current;
                        const distToStore = calculateDistance(newCoords, state.settings.storeLocation);
                        const GEOFENCE_RADIUS_KM = 0.1; // 100m
                        const AUTO_START_RADIUS_KM = 0.15; // 150m (buffer to avoid false starts)

                        // 1. AUTO-START LOGIC (If IDLE and user leaves zone)
                        if (state.tripStatus === TripStatus.IDLE) {
                            if (distToStore > AUTO_START_RADIUS_KM) {
                                // User has left the store significantly -> Start Trip
                                autoStartTrip(newCoords);
                            }
                        }

                        // 2. ACTIVE TRIP LOGIC
                        if (state.tripStatus !== TripStatus.IDLE && state.tripStatus !== TripStatus.COMPLETED) {
                            
                            // Check for Finish (Entering Zone)
                            if (state.hasLeftGeofence && distToStore <= GEOFENCE_RADIUS_KM) {
                                performFinishTrip(newCoords);
                                return; // Stop processing this update
                            }

                            // Mark as left geofence if outside
                            if (!state.hasLeftGeofence && distToStore > GEOFENCE_RADIUS_KM) {
                                setHasLeftGeofence(true);
                            }

                            // DISTANCE & DIRECTION CALCULATION
                            if (prevLocationRef.current) {
                                const moveDist = calculateDistance(prevLocationRef.current, newCoords);
                                const prevDistToStore = calculateDistance(prevLocationRef.current, state.settings.storeLocation);
                                
                                // Only count movement if significant (>10 meters) to reduce GPS jitter noise
                                if (moveDist > 0.01) {
                                    const deltaStore = distToStore - prevDistToStore;

                                    // If deltaStore is Positive -> Moving Away -> FORWARD
                                    if (deltaStore > 0.005) { 
                                        setForwardDist(d => d + moveDist);
                                        setTripStatus(TripStatus.FORWARD);
                                    } 
                                    // If deltaStore is Negative -> Moving Closer -> RETURN
                                    else if (deltaStore < -0.005) {
                                        setReverseDist(d => d + moveDist);
                                        setTripStatus(TripStatus.RETURN);
                                    }
                                    // If ambiguous (moving sideways), default to current status add
                                    else {
                                        if (state.tripStatus === TripStatus.FORWARD) setForwardDist(d => d + moveDist);
                                        else setReverseDist(d => d + moveDist);
                                    }
                                }
                            }
                        }
                        prevLocationRef.current = newCoords;
                    },
                    (err) => console.warn("GPS Watch Error:", err.message),
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
                return () => navigator.geolocation.clearWatch(watcher);
            }, []);

            const handleClearSynced = () => {
                if (window.confirm("Remove synced logs from device?")) {
                    const remainingLogs = clearSyncedLogs();
                    setLogs(remainingLogs);
                }
            };

            const currentRevenue = (forwardDist * settings.forwardRate) + (reverseDist * settings.reverseRate);
            const totalKm = forwardDist + reverseDist;
            const hasUnsynced = logs.some(l => !l.synced);
            const currentTripFuelConsumed = totalKm / (settings.mileage || 40);
            const effectiveFuelLevel = Math.max(0, settings.currentFuelLevel - currentTripFuelConsumed);
            const isReserve = effectiveFuelLevel <= settings.reserveLimit;
            const fuelPercent = (effectiveFuelLevel / settings.tankCapacity) * 100;
            const reservePercent = (settings.reserveLimit / settings.tankCapacity) * 100;

            return (
                <div className="flex flex-col h-full bg-dark-900 text-white relative">
                    <header className="absolute top-0 left-0 right-0 z-30 p-4 bg-gradient-to-b from-dark-900 via-dark-900/80 to-transparent pointer-events-none">
                        <div className="flex justify-between items-center pointer-events-auto">
                            <div className="flex items-center gap-2 bg-dark-800/80 backdrop-blur-md p-2 rounded-xl border border-white/5 shadow-lg">
                                <div className="bg-brand-500 p-1.5 rounded-lg text-white"><Bike size={20} /></div>
                                <div>
                                    <h1 className="font-bold text-sm leading-tight text-white">Fuel Savvy <span className="text-brand-400">Pro</span></h1>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className={`p-3 rounded-xl backdrop-blur-md border border-white/5 shadow-lg flex items-center justify-center transition-colors ${isSyncing ? 'bg-blue-500/20 text-blue-400' : hasUnsynced ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                    {isSyncing ? <RefreshCw size={20} className="animate-spin" /> : hasUnsynced ? (isOnline ? <CloudOff size={20} /> : <CloudOff size={20} className="opacity-50" />) : <Cloud size={20} />}
                                </div>
                                <button onClick={() => setIsHistoryOpen(true)} className="bg-dark-800/80 backdrop-blur-md p-3 rounded-xl border border-white/5 shadow-lg hover:bg-dark-700 text-white transition-all active:scale-95"><History size={20} /></button>
                                <button onClick={() => setIsSettingsOpen(true)} className="bg-dark-800/80 backdrop-blur-md p-3 rounded-xl border border-white/5 shadow-lg hover:bg-dark-700 text-white transition-all active:scale-95"><Settings size={20} /></button>
                            </div>
                        </div>
                    </header>
                    <div className="flex-1 relative z-0">
                        <MainMap currentLocation={currentLocation} settings={settings} targetLocation={targetLocation} tripStatus={tripStatus} />
                        {tripStatus !== TripStatus.IDLE && (
                            <div className="absolute top-24 right-4 z-20 flex flex-col gap-2 pointer-events-none">
                                {tripStatus === TripStatus.FORWARD && <div className="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg animate-pulse flex items-center gap-1"><Navigation size={12}/> FORWARD</div>}
                                {tripStatus === TripStatus.RETURN && <div className="bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg animate-pulse flex items-center gap-1"><History size={12}/> RETURNING</div>}
                                <div className="bg-dark-900/80 backdrop-blur text-gray-300 text-[10px] font-bold px-2 py-0.5 rounded border border-white/10">
                                   To Store: {currentLocation ? formatDistance(calculateDistance(currentLocation, settings.storeLocation)) : '?'}
                                </div>
                            </div>
                        )}
                        {targetLocation && tripStatus === TripStatus.IDLE && (
                            <div className="absolute top-24 right-4 z-20 pointer-events-none animate-in slide-in-from-bottom">
                                <div className="bg-red-500/90 backdrop-blur text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
                                    <Target size={12}/> Destination Set
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="bg-dark-800 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-30 flex flex-col transition-all duration-300 ease-in-out relative border-t border-white/5">
                        <div className="p-6 pb-8">
                            <div className="mb-6 bg-dark-700/50 rounded-xl p-3 border border-white/5 flex items-center gap-3">
                                <div className="flex-1">
                                    <div className="flex justify-between text-xs mb-1 font-semibold">
                                        <span className={isReserve ? "text-red-500 animate-pulse flex items-center gap-1" : "text-gray-400"}>{isReserve ? <><AlertTriangle size={12} className="text-red-500"/> RESERVE FUEL</> : 'Current Fuel'}</span>
                                        <span className="text-gray-300">{effectiveFuelLevel.toFixed(1)}L <span className="text-gray-500">/ {settings.tankCapacity}L</span></span>
                                    </div>
                                    <div className="relative h-3 w-full bg-dark-900 rounded-full overflow-hidden border border-white/10 mt-1">
                                        <div className="absolute left-0 top-0 bottom-0 bg-red-900/50 border-r border-red-500/50 z-0" style={{ width: `${reservePercent}%` }}></div>
                                        <div className={`absolute left-0 top-0 bottom-0 rounded-full transition-all duration-700 ease-out z-10 ${isReserve ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]' : 'bg-brand-500 shadow-[0_0_10px_rgba(34,197,94,0.3)]'}`} style={{ width: `${Math.min(100, fuelPercent)}%` }}></div>
                                    </div>
                                </div>
                                <button onClick={() => setIsFuelModalOpen(true)} className="bg-brand-600/20 hover:bg-brand-600/30 text-brand-400 p-2 rounded-lg border border-brand-500/30 transition-colors h-full flex flex-col items-center justify-center gap-1 min-w-[60px]"><Fuel size={20} /><span className="text-[10px] font-bold">+Add</span></button>
                            </div>
                            {isFuelModalOpen && (
                                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                                    <div className="bg-dark-800 w-full max-w-sm rounded-2xl p-6 border border-dark-600 shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-200">
                                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Fuel size={20} className="text-brand-500"/> Add Petrol</h3>
                                        <div className="flex bg-dark-900 rounded-lg p-1 mb-4">
                                            <button onClick={() => setFuelInputMode('AMOUNT')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-colors ${fuelInputMode === 'AMOUNT' ? 'bg-brand-600 text-white' : 'text-gray-400 hover:text-white'}`}>Amount (₹)</button>
                                            <button onClick={() => setFuelInputMode('LITERS')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-colors ${fuelInputMode === 'LITERS' ? 'bg-brand-600 text-white' : 'text-gray-400 hover:text-white'}`}>Liters (L)</button>
                                        </div>
                                        <div className="relative mb-2">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-lg">{fuelInputMode === 'AMOUNT' ? '₹' : 'L'}</span>
                                            <input type="number" autoFocus value={fuelInputAmount} onChange={(e) => setFuelInputAmount(e.target.value)} className="w-full bg-dark-900 border border-dark-600 rounded-xl p-4 pl-10 text-2xl font-bold text-white focus:border-brand-500 outline-none" placeholder={fuelInputMode === 'AMOUNT' ? "100" : "1.5"}/>
                                        </div>
                                        <div className="text-right text-xs text-gray-400 mb-6 font-mono">{fuelInputAmount ? (fuelInputMode === 'AMOUNT' ? `≈ ${(parseFloat(fuelInputAmount)/settings.fuelPrice).toFixed(2)} L @ ₹${settings.fuelPrice}/L` : `≈ ₹${(parseFloat(fuelInputAmount)*settings.fuelPrice).toFixed(0)}`) : 'Enter value'}</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => setIsFuelModalOpen(false)} className="bg-dark-700 hover:bg-dark-600 text-gray-300 py-3 rounded-xl font-bold">Cancel</button>
                                            <button onClick={handleAddFuel} className="bg-brand-600 hover:bg-brand-500 text-white py-3 rounded-xl font-bold">Fill Tank</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div className="flex justify-between items-end mb-6">
                                <div>
                                    <span className="text-gray-400 text-xs uppercase tracking-wider font-semibold">Earnings</span>
                                    <div className="text-5xl font-black text-white tracking-tight flex items-baseline gap-1">{formatCurrency(currentRevenue)}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-bold text-gray-200">{formatDistance(totalKm)}</div>
                                    <div className="text-gray-500 text-xs uppercase font-semibold">Distance</div>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className={`p-3 rounded-xl border transition-colors ${tripStatus === TripStatus.FORWARD ? 'bg-blue-500/10 border-blue-500/50' : 'bg-dark-700 border-transparent'}`}>
                                    <div className="text-[10px] uppercase text-gray-400 mb-1">Forward (@ ₹{settings.forwardRate})</div>
                                    <div className={`text-xl font-bold ${tripStatus === TripStatus.FORWARD ? 'text-blue-400' : 'text-gray-300'}`}>{formatDistance(forwardDist)}</div>
                                </div>
                                <div className={`p-3 rounded-xl border transition-colors ${tripStatus === TripStatus.RETURN ? 'bg-orange-500/10 border-orange-500/50' : 'bg-dark-700 border-transparent'}`}>
                                    <div className="text-[10px] uppercase text-gray-400 mb-1">Reverse (@ ₹{settings.reverseRate})</div>
                                    <div className={`text-xl font-bold ${tripStatus === TripStatus.RETURN ? 'text-orange-400' : 'text-gray-300'}`}>{formatDistance(reverseDist)}</div>
                                </div>
                            </div>
                            
                            {/* ACTION BUTTONS */}
                            <div className="grid grid-cols-4 gap-3">
                                {tripStatus === TripStatus.IDLE ? (
                                    <button onClick={manualStartTrip} className="col-span-4 bg-brand-600 hover:bg-brand-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-600/20 active:scale-95 transition-all flex items-center justify-center gap-2 text-lg">
                                        <Play fill="currentColor" /> Start Trip (Manual)
                                    </button>
                                ) : (
                                    <div className="col-span-4 bg-dark-700/50 p-2 rounded-xl flex items-center justify-between border border-white/5">
                                        <div className="flex items-center gap-3 px-2">
                                            <div className="relative">
                                                <div className="absolute inset-0 bg-brand-500 blur-lg opacity-20 animate-pulse"></div>
                                                <div className="bg-brand-500/20 text-brand-400 p-2 rounded-lg relative">
                                                    <Zap size={24} className="animate-pulse" />
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-gray-400 font-bold uppercase tracking-wider">Status</div>
                                                <div className="text-white font-bold flex items-center gap-1.5">
                                                    {tripStatus === TripStatus.FORWARD ? 'Going Away' : 'Returning'}
                                                    <span className="text-[10px] bg-dark-600 px-1.5 rounded text-gray-400">Auto-Detect</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={() => { if(window.confirm("Stop trip manually?")) performFinishTrip(); }} className="bg-red-500/10 hover:bg-red-500/20 text-red-500 p-3 rounded-lg border border-red-500/30 transition-all active:scale-95">
                                            <Square fill="currentColor" size={20} />
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <SettingsDialog isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} settings={settings} onSave={handleSaveSettings}/>
                    {isHistoryOpen && <HistoryPage logs={logs} refuelLogs={refuelLogs} onBack={() => setIsHistoryOpen(false)} onClearSynced={handleClearSynced}/>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>