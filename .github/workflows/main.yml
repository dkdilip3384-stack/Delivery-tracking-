name: Build FuelSavvy Pro (Deep Link Support)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Setup Java 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Cordova
        run: npm install -g cordova

      - name: Create Project & Configure
        run: |
          # 1. Create Project
          cordova create fuelapp com.fuelsavvy.pro "Fuel Savvy Pro"
          cd fuelapp
          
          # 2. Add Android Platform 11.0.0
          cordova platform add android@11.0.0
          
          # 3. Copy Web Assets
          rm -rf www/*
          cp ../index.html www/index.html
          
          # 4. Add Plugins
          cordova plugin add cordova-plugin-geolocation

      - name: Inject Deep Links (Smart Manifest Update)
        run: |
          cd fuelapp
          
          # Define the Intent Filters for Google Maps and Geo URIs
          # This block tells Android: "Hey, I can handle map links!"
          INTENT_FILTER='
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="geo" />
                <data android:scheme="https" android:host="maps.google.com" />
                <data android:scheme="http" android:host="maps.google.com" />
                <data android:scheme="https" android:host="www.google.com" android:pathPrefix="/maps" />
                <data android:scheme="https" android:host="maps.app.goo.gl" />
                <data android:scheme="https" android:host="goo.gl" />
            </intent-filter>
          '
          
          # Find the AndroidManifest.xml
          MANIFEST_PATH="platforms/android/app/src/main/AndroidManifest.xml"
          
          # Use sed to inject our Intent Filter right before the closing </activity> tag of the MainActivity
          # This is safer than replacing the whole file.
          # We search for the MAIN/LAUNCHER intent end, and append our map intents after it.
          
          # First, remove newlines from INTENT_FILTER for sed
          INTENT_ONE_LINE=$(echo "$INTENT_FILTER" | tr '\n' ' ')
          
          # Inject it into the manifest
          sed -i "s|<\/activity>|$INTENT_ONE_LINE<\/activity>|" $MANIFEST_PATH
          
          echo "Manifest Updated Successfully with Deep Links!"
          cat $MANIFEST_PATH

      - name: Build Debug APK
        run: |
          cd fuelapp
          export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx2048m"
          cordova build android --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: FuelSavvy-Pro-App
          path: fuelapp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
